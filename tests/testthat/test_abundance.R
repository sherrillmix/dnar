context("Test abundance functions")
test_that("Test shannon",{
	expect_equal(shannon(0),0) #a bit undefined
	expect_equal(shannon(1),0)
	expect_equal(shannon(c(1,1)),-log(1/2))
	expect_equal(shannon(c(1,1),2),-log2(1/2))
	expect_equal(shannon(rep(1,100)),-log(1/100))
	expect_equal(shannon(rep(1,100),10),-log10(1/100))
	expect_equal(shannon(1:3),sum(1:3*-log(1:3/6)/6))
	expect_error(shannon(c(rep(1,100),-1)),'positive')
	expect_equal(shannon(c(c(.25,.25),standardize=FALSE)),-.5*log(1/4))
})

test_that("Test rao",{
	expect_equal(rao(1,matrix(0)),0)
	expect_equal(rao(rep(1,2),matrix(c(0,1,1,0),nrow=2)),.5)
	expect_equal(rao(rep(1,2),matrix(c(0,1,1,0),nrow=2)),.5)
	expect_equal(rao(rep(1,2),matrix(c(0,2,2,0),nrow=2)),1)
	expect_error(rao(rep(1,2),as.matrix(dist(1:3))),'match')
	expect_error(rao(rep(1,3),as.matrix(dist(1:2))),'match')
	expect_equal(rao(rep(1,3),as.matrix(dist(1:3))),8/9)
	expect_equal(rao(rep(1,4),as.matrix(dist(1:4))),20/16)
	expect_equal(rao(1:3,as.matrix(dist(1:3))),28/36)
})

test_that("Test jensenShannon",{
	expect_equal(jensenShannon(1,1),0)
	expect_equal(jensenShannon(rep(1,20),rep(1,20)),0)
	expect_equal(jensenShannon(0:2,2:0),2/3)
	expect_equal(jensenShannon(0:1,1:0),1)
	expect_equal(jensenShannon(0:2,2:0,3),1+1/3*log(1/3,3)+2/3*log(2/3,3))
	expect_error(jensenShannon(rep(1,20),rep(1,21)),'[Ll]ength')
	counts1<-sample(1:100)
	counts2<-sample(1:100)
	expect_equal(jensenShannon(counts1,counts2),jensenShannon(counts2,counts1))
})

test_that("Test kullback",{
	expect_equal(kullback(1,1),0)
	expect_equal(kullback(0:1,1:0),NaN)
	expect_equal(kullback(c(1,1),0:1),Inf)
	expect_equal(kullback(0:1,c(1,1)),NaN)
	expect_equal(kullback(c(.5,.5),c(.2,.8)), sum(.5*log2(.5/c(.2,.8))))
	expect_equal(kullback(c(.5,.5),c(.2,.8),base=3), sum(.5*log(.5/c(.2,.8),3)))
	expect_equal(kullback(c(1,1,1),c(.1,.1,.8),base=3), sum(1/3*log(1/3/c(.1,.1,.8),3)))
	expect_equal(kullback(c(.1,.1,.8),c(1,1,1)), sum(c(.1,.1,.8)*log2(c(.1,.1,.8)*3)))
})

test_that("Test chao",{
	expect_equal(chao(-1),0)
	expect_equal(chao(0),0)
	expect_equal(chao(1),1)
	expect_equal(chao(rep(1,2)),3)
	expect_equal(chao(rep(1,3)),6)
	expect_equal(chao(rep(1,4)),10)
	expect_equal(chao(c(rep(1,2),rep(2,1))),3.5)
	expect_equal(chao(c(rep(1,2),rep(2,1),rep(100,100))),103.5)
	expect_equal(chao(c(rep(1,4),rep(100,100))),110)
	expect_equal(chao(c(rep(1,4),rep(2,4),rep(100,100))),108+4*3/2/5)
})

test_that("Test rarefaction",{
	expect_equal(rarefy(rep(1,100),1,reps=1000)[,3],1)
	expect_equal(rarefy(rep(1,100),100,reps=1000)[,1],100)
	expect_equal(rarefy(100,100,reps=1000)[,3],1)
	out<-data.frame('50%'=1:2,'2.5%'=1:2,'97.5%'=1:2,row.names=c(1,100),check.names=FALSE)
	expect_equal(rarefy(c(50,50),c(1,100),reps=1000),out)
	expect_equal(rarefy(c(50,50),2,reps=1000,chao=TRUE)[,3],3)
})
